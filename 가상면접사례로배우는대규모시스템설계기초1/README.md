# 가상 면접 사례로 배우는 대규모 시스템 설계 기초1

워낙에 유명한 책이고 나도 뜨문뜨문 봤던 책이라 정리하면서 읽어볼까해서 적어본다.

## 2장. 개략적인 규모 추정

- 설계 면접에서는 시스템 용량이나 성능 요구사항을 개략적으로 추정해보라는 요구를 받게 되는데 이게 "개략적인 규모 추정" 이라고 책에서 정의내리고 있다.
- 개략적 규모 추정은 정밀한 측정이 아니기에 추정값이고 면접자의 논리력이 뒷받침되어야 하는데 논리의 근거가 되는 소스들이 "2의 제곱수", "응답지연(latency)", "가용성에 관계된 수치"들이다.
  - 수치는 책을 통해 확인해보자!
- 읽으면서 '아맞다' 했던 부분이 "압축"이었다. 압축을 통해서 데이터 크기를 줄이고 보내는 응답지연을 줄이는 방법에 대해선 간과했던 부분이었던 것 같다.
- QPS : Query Per Second

## 3장. 시스템 설계 면접 공략법

- 문제 이해 및 설계 범위 확정
  - 질문을 통해 모호함을 없애고 스타트!
- 개략적인 설계안제시 및 동의 구하기
- 상세 설계
- 마무리

## 4장. 처리율 제한 장치의 설계

- rate limiter는 말그대로 트래픽의 처리율(Rate)를 제어하는 장치다
- 제어함으로써 DDoS 공격도 막을 수 있고, 서버의 과부하 또한 막을 수 있을 것이다.
  - 예시로, 네이버 메일 페이지에서 새로고침 50번쯤하면 조회가 제한되는 것을 볼 수 있다.
- 문제 이해 및 설계 범위 확정!
  - 클라이언트측 제한? 서버측 제한?
  - 어떤 기준으로 제한? endpoint? IP? 사용자ID? etc
  - 설계한 시스템의 내구성(tolerance)은 어느정도?
  - 분산환경에서 동작?
- 개략적 설계안 제시 및 동의 구하기
  - 읽으면서 좋았던 부분은 "클라이언트 측 rate limiter는 위변조가 가능하기때문에..." 부분이다. 내가 간과하고 있던 부분이다. 설계를 할 때에 rate limiter는 클라이언트가 아닌 서버에 두는 것이 좋다.
  - rate limit 알고리즘에는 여러 가지가 있는데 그들중 각각의 장단점을 비교해 선택하면 좋다.
    - Rate limiter로 많이 쓰이는 bucket4j, resilience4j 라이브러리 모두 토큰버킷 알고리즘을 사용하고 있다. 물론 이게 제일 좋아서는 아니겠지만 간단한 구현방식과 트래픽 과부하에도 내성이 있기 때문에 많이 차용되는 것이 아닐까 싶다.
    - 이건 몰랐는데 Redis로도 많이 구현하는 것 같다.
- 상세 설계
  - 만약 분산환경에서 rate limiter를 레디스로 구현한다했을 때, 문제가 생길 수 있는데 이건 "경쟁조건"과 "동기화" 이다.
  - 이런 문제를 바로 해결할 수 있는 방법은 사실 "락"인데 이는 너무 많은 성능 저하를 불러올 수 있다. 다만 트레이드오프로 쓰기의 성능은 크게 개의치않고, 데이터의 조회 성능과 조회 시 데이터의 정합성이 더욱 큰 이슈라면 쓰기 성능을 포기할수도 있다.
  - 락으로 쓰기 성능도 포기하고 싶지 않다면 레디스의 "루아 스크립트(Lua script)", "정렬 집합(sorted set)"을 활용하는 것도 방법이다.
  - 만약 rate limiter를 분산형으로 운영하고 싶다면 중앙집중형으로 redis를 활용하는 것 또한 방법이다. sticky session 방식을 사용하는것은 확장성에 좋지 않다는 필자의 의견에 동의한다!
